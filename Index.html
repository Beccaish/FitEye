<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scale=no">
<title>FitEye — Gym Equipment ID</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-card: #161616;
    --accent: #c8ff00;
    --accent-dim: #6b8a00;
    --accent-glow: rgba(200, 255, 0, 0.15);
    --danger: #ff2a2a;
    --text-primary: #f0f0f0;
    --text-secondary: #888888;
    --text-muted: #555555;
    --border: #222222;
    --border-accent: #2a2a2a;
  }

  .dark {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-card: #161616;
    --text-primary: #f0f0f0;
    --text-secondary: #888888;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: 'Space Mono', monospace;
    -webkit-font-smoothing: antialiased;
  }

  .app-container {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  .app-container::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 20% 0%, rgba(200, 255, 0, 0.03) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(200, 255, 0, 0.02) 0%, transparent 50%),
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.008) 2px, rgba(255,255,255,0.008) 4px);
    pointer-events: none;
    z-index: 0;
  }

  .app-container::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0, 0, 0, 0.08) 3px, rgba(0, 0, 0, 0.08) 6px);
    pointer-events: none;
    z-index: 1;
  }

  /* HEADER */
  .header {
    position: relative;
    z-index: 10;
    padding: 16px 20px 12px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-primary);
    flex-shrink: 0;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  .brand-icon {
    width: 36px;
    height: 36px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  }

  .brand-icon i { color: #0a0a0a; font-size: 14px; }

  .brand-text h1 {
    font-family: 'Archivo Black', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    color: var(--text-primary);
    line-height: 1;
  }

  .brand-text span {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .header-status {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse-dot 2s infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .btn-home {
    display: none;
    width: 38px;
    height: 38px;
    background: var(--bg-card);
    border: 1px solid var(--border-accent);
    border-radius: 6px;
    color: var(--text-muted);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
    flex-shrink: 0;
  }

  .btn-home:hover { background: var(--accent); color: #0a0a0a; border-color: var(--accent); }
  .btn-home i { font-size: 14px; }

  .btn-home.show { display: flex; }

  /* MAIN CONTENT */
  .main-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    z-index: 5;
    scroll-behavior: smooth;
  }

  .main-content::-webkit-scrollbar { width: 3px; }
  .main-content::-webkit-scrollbar-track { background: transparent; }
  .main-content::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

  /* CAPTURE ZONE */
  .capture-zone {
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    min-height: 100%;
    justify-content: center;
    transition: min-height 0.3s, justify-content 0.3s;
  }

  .capture-zone.has-content {
    min-height: unset;
    justify-content: flex-start;
  }

  .capture-frame {
    width: 100%;
    max-width: 400px;
    aspect-ratio: 3/4;
    border: 2px dashed var(--border-accent);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--bg-secondary);
  }

  .capture-frame:hover, .capture-frame:focus-visible {
    border-color: var(--accent-dim);
    box-shadow: 0 0 30px var(--accent-glow);
  }

  .capture-frame.has-image {
    border-color: var(--accent);
    border-style: solid;
    aspect-ratio: unset;
    cursor: default;
  }

  .capture-frame.has-image:hover { box-shadow: none; }

  .capture-frame.has-image .capture-placeholder { display: none; }

  .capture-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 20px;
    text-align: center;
  }

  .capture-icon-ring {
    width: 80px;
    height: 80px;
    border: 2px solid var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: ring-breathe 3s infinite;
  }

  @keyframes ring-breathe {
    0%, 100% { box-shadow: 0 0 0 0 rgba(200, 255, 0, 0.1); }
    50% { box-shadow: 0 0 0 15px rgba(200, 255, 0, 0); }
  }

  .capture-icon-ring i { font-size: 28px; color: var(--accent); }

  .capture-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
    color: var(--text-secondary);
  }

  .capture-sublabel {
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    max-width: 240px;
    line-height: 1.6;
  }

  .corner-mark {
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: var(--accent);
    border-style: solid;
    border-width: 0;
    opacity: 0.5;
    transition: opacity 0.3s;
  }
  .corner-mark.tl { top: 10px; left: 10px; border-top-width: 2px; border-left-width: 2px; }
  .corner-mark.tr { top: 10px; right: 10px; border-top-width: 2px; border-right-width: 2px; }
  .corner-mark.bl { bottom: 10px; left: 10px; border-bottom-width: 2px; border-left-width: 2px; }
  .corner-mark.br { bottom: 10px; right: 10px; border-bottom-width: 2px; border-right-width: 2px; }

  .capture-frame.has-image .corner-mark { opacity: 0; }

  .captured-image {
    width: 100%;
    display: block;
    border-radius: 2px;
  }

  .image-overlay-tag {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(0,0,0,0.75);
    color: var(--accent);
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 2px;
    backdrop-filter: blur(4px);
    display: none;
  }

  .capture-frame.has-image .image-overlay-tag { display: block; }

  #cameraInput, #uploadInput { display: none; }

  /* DUAL CAPTURE BUTTONS */
  .capture-btn-row {
    display: flex;
    gap: 10px;
    width: 100%;
    max-width: 400px;
  }

  .btn-capture {
    flex: 1;
    padding: 14px 12px;
    background: var(--bg-card);
    border: 1px solid var(--border-accent);
    color: var(--text-secondary);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .btn-capture:hover {
    border-color: var(--accent-dim);
    color: var(--accent);
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .btn-capture i { font-size: 16px; }

  .btn-capture.primary-capture {
    background: var(--accent);
    color: #0a0a0a;
    border-color: var(--accent);
    clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
  }

  .btn-capture.primary-capture:hover {
    background: #d9ff33;
    box-shadow: 0 0 25px var(--accent-glow);
  }

  /* ACTIONS */
  .action-row {
    display: flex;
    gap: 10px;
    width: 100%;
    max-width: 400px;
  }

  .btn-identify {
    flex: 1;
    padding: 14px 20px;
    background: var(--accent);
    color: #0a0a0a;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
  }

  .btn-identify:hover { background: #d9ff33; transform: translateY(-1px); }
  .btn-identify:active { transform: translateY(0); }
  .btn-identify:disabled {
    background: var(--border-accent);
    color: var(--text-muted);
    cursor: not-allowed;
    transform: none;
  }

  .btn-retake {
    padding: 14px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border-accent);
    color: var(--text-secondary);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .btn-retake:hover { border-color: var(--danger); color: var(--danger); }

  /* RESULT SECTION */
  .result-section {
    width: 100%;
    max-width: 400px;
    margin-top: 4px;
    padding-bottom: 20px;
  }

  .result-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 0;
    overflow: hidden;
  }

  .result-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(200, 255, 0, 0.03);
  }

  .result-header i { color: var(--accent); font-size: 14px; }

  .result-header span {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--text-primary);
  }

  .result-body {
    padding: 16px;
    font-size: 13px;
    line-height: 1.8;
    color: var(--text-secondary);
    overflow-wrap: break-word;
    word-break: break-word;
  }

  .result-body h1, .result-body h2, .result-body h3 {
    font-family: 'Archivo Black', sans-serif;
    color: var(--accent);
    margin: 16px 0 8px;
    letter-spacing: 1px;
  }

  .result-body h1 { font-size: 18px; }
  .result-body h2 { font-size: 15px; }
  .result-body h3 { font-size: 13px; }
  .result-body h1:first-child, .result-body h2:first-child, .result-body h3:first-child { margin-top: 0; }

  .result-body p { margin: 8px 0; }
  .result-body strong { color: var(--text-primary); }
  .result-body em { color: var(--accent-dim); font-style: italic; }

  .result-body ul, .result-body ol {
    margin: 8px 0;
    padding-left: 20px;
  }

  .result-body li { margin: 4px 0; padding-left: 4px; }
  .result-body li::marker { color: var(--accent); }

  .result-body code {
    background: rgba(200, 255, 0, 0.08);
    color: var(--accent);
    padding: 1px 5px;
    border-radius: 2px;
    font-size: 12px;
  }

  .result-body hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }

  /* SHOW ME BUTTON */
  .btn-showme {
    width: 100%;
    padding: 14px 20px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 12px;
  }

  .btn-showme:hover {
    background: var(--accent);
    color: #0a0a0a;
    box-shadow: 0 0 25px var(--accent-glow);
  }

  .btn-showme:disabled {
    border-color: var(--border-accent);
    color: var(--text-muted);
    cursor: not-allowed;
    background: transparent;
    box-shadow: none;
  }

  /* FORM IMAGE CARD */
  .form-image-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-top: 10px;
  }

  .form-image-card .result-header { border-bottom: 1px solid var(--border); }

  .form-image-body {
    padding: 0;
    position: relative;
    min-height: 80px;
  }

  .form-image-body img {
    width: 100%;
    display: block;
  }

  .form-image-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 40px 20px;
    text-align: center;
  }

  .form-image-loading .spinner-ring {
    width: 40px;
    height: 40px;
    border: 2px solid var(--border-accent);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .form-image-loading span {
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .form-image-caption {
    padding: 10px 14px;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    border-top: 1px solid var(--border);
    line-height: 1.5;
  }

  /* LOADING STATE */
  .loading-bar {
    width: 100%;
    height: 2px;
    background: var(--bg-secondary);
    overflow: hidden;
    border-radius: 1px;
  }

  .loading-bar-inner {
    height: 100%;
    width: 40%;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: loading-slide 1.2s infinite;
  }

  @keyframes loading-slide {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(350%); }
  }

  .loading-text {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .loading-text .dot-flash::after {
    content: '';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
  }

  /* TIPS GRID */
  .tips-row {
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 400px;
  }

  .tip-chip {
    flex: 1;
    padding: 8px 6px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    text-align: center;
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    line-height: 1.5;
  }

  .tip-chip i {
    display: block;
    margin-bottom: 4px;
    color: var(--accent-dim);
    font-size: 14px;
  }

  /* ERROR STATE */
  .error-msg {
    color: var(--danger);
    font-size: 12px;
    padding: 12px 16px;
    border: 1px solid rgba(255, 42, 42, 0.2);
    background: rgba(255, 42, 42, 0.05);
  }

  /* ANIMATIONS */
  @keyframes fade-up {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .anim-fade-up { animation: fade-up 0.4s ease forwards; }

  .delay-1 { animation-delay: 0.1s; opacity: 0; }
  .delay-2 { animation-delay: 0.2s; opacity: 0; }
  .delay-3 { animation-delay: 0.3s; opacity: 0; }
  .delay-4 { animation-delay: 0.35s; opacity: 0; }

  /* RESPONSIVE */
  @media (max-width: 380px) {
    .brand-text h1 { font-size: 15px; letter-spacing: 2px; }
    .capture-label { font-size: 18px; }
    .btn-identify { font-size: 16px; }
    .btn-capture { font-size: 14px; letter-spacing: 1px; padding: 12px 8px; }
    .header-status { display: none; }
  }

  @media (min-height: 800px) {
    .capture-zone { gap: 20px; }
  }
</style>
</head>
<body>
<div class="app-container">
  <!-- HEADER -->
  <div class="header anim-fade-up">
    <div class="header-top">
      <div class="brand" id="brandHome" title="Go home" aria-label="Go back to home screen">
        <div class="brand-icon"><i class="fas fa-eye"></i></div>
        <div class="brand-text">
          <h1>FitEye</h1>
          <span>Equipment Identifier</span>
        </div>
      </div>
      <div class="header-right">
        <div class="header-status">
          <div class="status-dot"></div>
          AI Online
        </div>
        <button class="btn-home" id="btnHome" title="Back to home" aria-label="Go back to home screen">
          <i class="fas fa-home"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main-content" id="mainContent">
    <div class="capture-zone" id="captureZone">

      <!-- Capture Frame -->
      <div class="capture-frame anim-fade-up delay-1" id="captureFrame" tabindex="0" role="button" aria-label="Tap to take a photo of gym equipment">
        <div class="capture-placeholder">
          <div class="capture-icon-ring">
            <i class="fas fa-camera"></i>
          </div>
          <div class="capture-label">SNAP EQUIPMENT</div>
          <div class="capture-sublabel">Take a photo or upload an image of any gym machine to identify it</div>
        </div>
        <div class="corner-mark tl"></div>
        <div class="corner-mark tr"></div>
        <div class="corner-mark bl"></div>
        <div class="corner-mark br"></div>
        <img class="captured-image" id="capturedImage" alt="Captured gym equipment">
        <div class="image-overlay-tag"><i class="fas fa-check"></i>&ensp;CAPTURED</div>
      </div>

      <!-- Hidden file inputs -->
      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      <input type="file" id="uploadInput" accept="image/*">

      <!-- Dual capture buttons -->
      <div class="capture-btn-row anim-fade-up delay-2" id="captureBtnRow">
        <button class="btn-capture primary-capture" id="btnTakePhoto">
          <i class="fas fa-camera"></i>
          <span>TAKE PHOTO</span>
        </button>
        <button class="btn-capture" id="btnUpload">
          <i class="fas fa-images"></i>
          <span>UPLOAD</span>
        </button>
      </div>

      <!-- Tips -->
      <div class="tips-row anim-fade-up delay-3" id="tipsRow">
        <div class="tip-chip"><i class="fas fa-sun"></i>Good lighting</div>
        <div class="tip-chip"><i class="fas fa-expand"></i>Full machine</div>
        <div class="tip-chip"><i class="fas fa-bullseye"></i>Clear focus</div>
      </div>

      <!-- Actions (shown after image) -->
      <div class="action-row anim-fade-up delay-4" id="actionRow" style="display:none;">
        <button class="btn-identify" id="btnIdentify" disabled>
          <i class="fas fa-bolt"></i>
          <span>IDENTIFY</span>
        </button>
        <button class="btn-retake" id="btnRetake" title="New photo">
          <i class="fas fa-redo"></i>
          <span>NEW</span>
        </button>
      </div>

      <!-- Result -->
      <div class="result-section" id="resultSection" style="display:none;"></div>

      <!-- Show Me form image section -->
      <div class="result-section" id="formImageSection" style="display:none;"></div>

    </div>
  </div>
</div>

<script>
  // === Dark mode ===
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
  }
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
    if (event.matches) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  });

  // === State ===
  var currentFile = null;
  var isProcessing = false;
  var isGeneratingImage = false;
  var identifiedEquipmentName = '';
  var analysisContent = '';

  // === DOM refs ===
  var captureFrame = document.getElementById('captureFrame');
  var cameraInput = document.getElementById('cameraInput');
  var uploadInput = document.getElementById('uploadInput');
  var capturedImage = document.getElementById('capturedImage');
  var btnIdentify = document.getElementById('btnIdentify');
  var btnTakePhoto = document.getElementById('btnTakePhoto');
  var btnUpload = document.getElementById('btnUpload');
  var btnRetake = document.getElementById('btnRetake');
  var btnHome = document.getElementById('btnHome');
  var brandHome = document.getElementById('brandHome');
  var resultSection = document.getElementById('resultSection');
  var formImageSection = document.getElementById('formImageSection');
  var captureZone = document.getElementById('captureZone');
  var tipsRow = document.getElementById('tipsRow');
  var actionRow = document.getElementById('actionRow');
  var captureBtnRow = document.getElementById('captureBtnRow');
  var mainContent = document.getElementById('mainContent');

  // === Configure marked ===
  marked.setOptions({ breaks: true, gfm: true });

  // === Show / hide home button ===
  function showHomeButton() {
    btnHome.classList.add('show');
  }

  function hideHomeButton() {
    btnHome.classList.remove('show');
  }

  // === Capture via camera ===
  btnTakePhoto.addEventListener('click', function() {
    if (!isProcessing) cameraInput.click();
  });

  // === Upload from gallery ===
  btnUpload.addEventListener('click', function() {
    if (!isProcessing) uploadInput.click();
  });

  // === Tapping the frame also opens camera ===
  captureFrame.addEventListener('click', function() {
    if (!isProcessing && !currentFile) cameraInput.click();
  });

  captureFrame.addEventListener('keydown', function(e) {
    if ((e.key === 'Enter' || e.key === ' ') && !isProcessing && !currentFile) {
      e.preventDefault();
      cameraInput.click();
    }
  });

  // === Handle file selected ===
  function handleFileSelected(file) {
    if (!file) return;
    currentFile = file;

    var reader = new FileReader();
    reader.onload = function(ev) {
      capturedImage.src = ev.target.result;
      captureFrame.classList.add('has-image');
      btnIdentify.disabled = false;
      captureZone.classList.add('has-content');

      captureBtnRow.style.display = 'none';
      tipsRow.style.display = 'none';
      actionRow.style.display = '';

      showHomeButton();

      resultSection.style.display = 'none';
      resultSection.innerHTML = '';
      formImageSection.style.display = 'none';
      formImageSection.innerHTML = '';
      identifiedEquipmentName = '';
      analysisContent = '';
    };
    reader.readAsDataURL(file);
  }

  cameraInput.addEventListener('change', function(e) {
    handleFileSelected(e.target.files[0]);
  });

  uploadInput.addEventListener('change', function(e) {
    handleFileSelected(e.target.files[0]);
  });

  // === Home / Retake ===
  btnRetake.addEventListener('click', function() {
    if (!isProcessing && !isGeneratingImage) goHome();
  });

  btnHome.addEventListener('click', function() {
    if (!isProcessing && !isGeneratingImage) goHome();
  });

  brandHome.addEventListener('click', function() {
    if (!isProcessing && !isGeneratingImage) goHome();
  });

  function goHome() {
    currentFile = null;
    capturedImage.src = '';
    captureFrame.classList.remove('has-image');
    btnIdentify.disabled = true;
    cameraInput.value = '';
    uploadInput.value = '';

    captureBtnRow.style.display = '';
    tipsRow.style.display = '';
    actionRow.style.display = 'none';
    resultSection.style.display = 'none';
    resultSection.innerHTML = '';
    formImageSection.style.display = 'none';
    formImageSection.innerHTML = '';

    captureZone.classList.remove('has-content');
    hideHomeButton();

    identifiedEquipmentName = '';
    analysisContent = '';

    btnIdentify.innerHTML = '<i class="fas fa-bolt"></i><span>IDENTIFY</span>';
    btnRetake.style.display = '';

    mainContent.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // === Identify ===
  btnIdentify.addEventListener('click', identifyEquipment);

  // === Register handlers ===
  if (window.Poe) {
    window.Poe.registerHandler('gym-identifier', function(result) {
      var msg = result.responses[0];
      if (!msg) return;

      if (msg.status === 'error') {
        showError(msg.statusText || 'Something went wrong. Try again.');
        setProcessing(false);
        return;
      }

      if (msg.status === 'incomplete') {
        analysisContent = msg.content;
        renderResult(msg.content, false);
      }

      if (msg.status === 'complete') {
        analysisContent = msg.content;
        extractEquipmentName(msg.content);
        renderResult(msg.content, true);
        setProcessing(false);
      }
    });

    window.Poe.registerHandler('form-image-handler', function(result) {
      var msg = result.responses[0];
      if (!msg) return;

      if (msg.status === 'error') {
        showFormImageError(msg.statusText || 'Could not generate image.');
        isGeneratingImage = false;
        return;
      }

      if (msg.status === 'complete') {
        if (msg.attachments && msg.attachments.length > 0) {
          showFormImage(msg.attachments[0].url);
        } else {
          showFormImageError('No image was generated. Try again.');
        }
        isGeneratingImage = false;
      }
    });
  }

  function extractEquipmentName(content) {
    // Try to grab the equipment name from the first heading
    var lines = content.split('\n');
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i].trim();
      // Skip the heading markers like "## Equipment Name"
      if (line.match(/^#+\s*(equipment\s*name|what\s*is\s*it)/i)) {
        // The name is likely on the next non-empty line
        for (var j = i + 1; j < lines.length; j++) {
          var next = lines[j].trim();
          if (next && !next.startsWith('#')) {
            identifiedEquipmentName = next.replace(/\*+/g, '').replace(/^[-–—]\s*/, '').trim();
            return;
          }
        }
      }
    }
    // Fallback: grab first bold text or first significant line after first heading
    var boldMatch = content.match(/\*\*(.+?)\*\*/);
    if (boldMatch) {
      identifiedEquipmentName = boldMatch[1].trim();
    }
  }

  async function identifyEquipment() {
    if (!currentFile || isProcessing) return;

    setProcessing(true);
    showLoading();
    formImageSection.style.display = 'none';
    formImageSection.innerHTML = '';

    var prompt = 'You are FitEye, an expert gym equipment analyst. Analyze this image and provide:\n\n' +
      '## Equipment Name\n' +
      'State the exact name of this gym machine/equipment in bold on its own line.\n\n' +
      '## What It Does\n' +
      'Briefly explain what this machine is designed for — which muscle groups it targets and its primary purpose.\n\n' +
      '## How to Use It\n' +
      'Step-by-step instructions on proper form and usage. Be concise but thorough. Include seat/handle adjustments if applicable.\n\n' +
      '## Common Mistakes\n' +
      'List 2-3 common form mistakes people make on this machine and how to avoid them.\n\n' +
      '## Pro Tips\n' +
      'Give 1-2 advanced tips for getting more out of this equipment.\n\n' +
      'Keep the tone direct and motivating — like a no-BS gym bro who actually knows their stuff. Use short sentences. Be practical.';

    try {
      await window.Poe.sendUserMessage('@GPT-5.2 ' + prompt, {
        handler: 'gym-identifier',
        stream: true,
        openChat: false,
        attachments: [currentFile],
        parameters: {}
      });
    } catch (err) {
      var errorType = (err && err.errorType) ? err.errorType : '';
      if (errorType === 'USER_REJECTED_CONFIRMATION') {
        showError('Request cancelled.');
      } else {
        showError('Failed to send. Check your connection and try again.');
      }
      setProcessing(false);
    }
  }

  // === Show Me — generate form image ===
  async function generateFormImage() {
    if (isGeneratingImage || !identifiedEquipmentName) return;
    isGeneratingImage = true;

    // Show loading state
    formImageSection.style.display = 'block';
    formImageSection.innerHTML =
      '<div class="form-image-card anim-fade-up">' +
        '<div class="result-header">' +
          '<i class="fas fa-image"></i>' +
          '<span>GENERATING FORM GUIDE</span>' +
        '</div>' +
        '<div class="form-image-body">' +
          '<div class="form-image-loading">' +
            '<div class="spinner-ring"></div>' +
            '<span>Creating visual guide<span class="dot-flash"></span></span>' +
          '</div>' +
        '</div>' +
      '</div>';
    scrollToBottom();

    // Disable the show-me button
    var showMeBtn = document.getElementById('btnShowMe');
    if (showMeBtn) {
      showMeBtn.disabled = true;
      showMeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GENERATING...';
    }

    var imagePrompt = 'A clear, professional fitness illustration showing proper form and body positioning for using a ' +
      identifiedEquipmentName +
      ' at the gym. Show a fit person demonstrating correct posture and grip with labeled muscle engagement zones highlighted in neon green. ' +
      'Dark gym background with dramatic lighting. Clean instructional style, similar to a fitness guide or manual.';

    try {
      await window.Poe.sendUserMessage('@Imagen-4-Fast ' + imagePrompt, {
        handler: 'form-image-handler',
        stream: false,
        openChat: false,
        parameters: { aspect_ratio: '3:4' }
      });
    } catch (err) {
      showFormImageError('Failed to generate image. Try again.');
      isGeneratingImage = false;
    }
  }

  function showFormImage(url) {
    formImageSection.style.display = 'block';
    formImageSection.innerHTML =
      '<div class="form-image-card anim-fade-up">' +
        '<div class="result-header">' +
          '<i class="fas fa-image"></i>' +
          '<span>FORM GUIDE — ' + escapeHtml(identifiedEquipmentName.toUpperCase()) + '</span>' +
        '</div>' +
        '<div class="form-image-body">' +
          '<img src="' + url + '" alt="Proper form for ' + escapeHtml(identifiedEquipmentName) + '">' +
        '</div>' +
        '<div class="form-image-caption">' +
          '<i class="fas fa-info-circle"></i>&ensp;AI-generated illustration — always consult a trainer for personalized guidance' +
        '</div>' +
      '</div>';

    var showMeBtn = document.getElementById('btnShowMe');
    if (showMeBtn) {
      showMeBtn.disabled = false;
      showMeBtn.innerHTML = '<i class="fas fa-image"></i> SHOW ME AGAIN';
    }
    scrollToBottom();
  }

  function showFormImageError(msg) {
    formImageSection.style.display = 'block';
    formImageSection.innerHTML =
      '<div class="error-msg anim-fade-up">' +
        '<i class="fas fa-exclamation-triangle"></i>&ensp;' + msg +
      '</div>';
    var showMeBtn = document.getElementById('btnShowMe');
    if (showMeBtn) {
      showMeBtn.disabled = false;
      showMeBtn.innerHTML = '<i class="fas fa-image"></i> SHOW ME HOW';
    }
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  // === UI Helpers ===
  function setProcessing(processing) {
    isProcessing = processing;
    btnIdentify.disabled = processing || !currentFile;
    if (processing) {
      btnIdentify.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>SCANNING</span>';
      btnRetake.style.display = 'none';
    } else {
      btnIdentify.innerHTML = '<i class="fas fa-bolt"></i><span>IDENTIFY</span>';
      btnRetake.style.display = '';
    }
  }

  function showLoading() {
    resultSection.style.display = 'block';
    resultSection.innerHTML =
      '<div class="result-card anim-fade-up">' +
        '<div class="loading-bar"><div class="loading-bar-inner"></div></div>' +
        '<div class="loading-text">' +
          '<i class="fas fa-microscope"></i>' +
          '<span>Analyzing equipment<span class="dot-flash"></span></span>' +
        '</div>' +
      '</div>';
    scrollToBottom();
  }

  function renderResult(content, isComplete) {
    var htmlContent = marked.parse(content || '');
    var iconClass = isComplete ? 'fa-check-circle' : 'fa-circle-notch fa-spin';
    var label = isComplete ? 'ANALYSIS COMPLETE' : 'ANALYZING...';
    var loadingBarHtml = isComplete ? '' : '<div class="loading-bar"><div class="loading-bar-inner"></div></div>';
    var cardClass = isComplete ? 'result-card anim-fade-up' : 'result-card';

    var showMeHtml = '';
    if (isComplete && identifiedEquipmentName) {
      showMeHtml =
        '<button class="btn-showme" id="btnShowMe" onclick="generateFormImage()">' +
          '<i class="fas fa-image"></i> SHOW ME HOW' +
        '</button>';
    }

    resultSection.style.display = 'block';
    resultSection.innerHTML =
      '<div class="' + cardClass + '">' +
        '<div class="result-header">' +
          '<i class="fas ' + iconClass + '"></i>' +
          '<span>' + label + '</span>' +
        '</div>' +
        loadingBarHtml +
        '<div class="result-body">' + htmlContent + '</div>' +
      '</div>' +
      showMeHtml;
    scrollToBottom();
  }

  function showError(msg) {
    resultSection.style.display = 'block';
    resultSection.innerHTML =
      '<div class="error-msg anim-fade-up">' +
        '<i class="fas fa-exclamation-triangle"></i>&ensp;' + msg +
      '</div>';
  }

  function scrollToBottom() {
    requestAnimationFrame(function() {
      mainContent.scrollTo({
        top: mainContent.scrollHeight,
        behavior: 'smooth'
      });
    });
  }
</script>
</body>
</html>

